---
title: Androidæ’ä»¶åŒ–åŸç†ç®€è¿°
date: 2018-08-17 15:18:34
tags:
  - Android
  - å®‰å“  
  - æ’ä»¶åŒ–   
---

## æ’ä»¶åŒ–æŠ€æœ¯å‡ºç°èƒŒæ™¯
- #### APPä½“ç§¯è¶Šæ¥è¶Šåºå¤§ï¼ŒåŠŸèƒ½æ¨¡å—è¶Šæ¥è¶Šå¤š
- #### æ¨¡å—è€¦åˆåº¦é«˜ï¼ŒååŒå¼€å‘æ²Ÿé€šæˆæœ¬æå¤§ 
- #### æ–¹æ³•æ•°å¯èƒ½æŸ¥è¿‡65535ï¼Œå ç”¨å†…å­˜è¿‡å¤§
<!--more-->
## ä»¥ä¸Šé—®é¢˜å¦‚ä½•è§£å†³
- #### å°†ä¸€ä¸ªå¤§çš„apkæŒ‰ç…§ä¸šåŠ¡åˆ†å‰²æˆå¤šä¸ªå°çš„apk
- #### æ¯ä¸ªå°çš„apkå³å¯ä»¥ç‹¬ç«‹è¿è¡Œåˆå¯ä»¥ä½œä¸ºæ’ä»¶è¿è¡Œ

## æ’ä»¶åŒ–ä¼˜åŠ¿
- #### ä¸šåŠ¡æ¨¡å—åŸºæœ¬å®Œå…¨è§£è€¦
- #### é«˜æ•ˆå¹¶è¡Œå¼€å‘ï¼ˆç¼–è¯‘é€Ÿåº¦æ›´å¿«ï¼‰
- #### æŒ‰éœ€åŠ è½½ï¼Œå†…å­˜å ç”¨æ›´ä½ç­‰ç­‰

## åŸºæœ¬æ¦‚å¿µ
- #### å®¿ä¸»ï¼šä¸»App,å¯ä»¥åŠ è½½æ’ä»¶ï¼Œä¹Ÿæˆä¸ºHost
- #### æ’ä»¶ï¼šæ’ä»¶App,è¢«å®¿ä¸»åŠ è½½çš„Appï¼Œå¯ä»¥æ˜¯è·Ÿæ™®é€šAppä¸€æ ·çš„Apkæ–‡ä»¶
- #### æ’ä»¶åŒ–ï¼šå°†ä¸€ä¸ªåº”ç”¨æŒ‰ç…§å®¿ä¸»æ’ä»¶çš„æ–¹å¼æ”¹é€ å°±å«æ’ä»¶åŒ–

## ç»“æ„å¯¹æ¯”
![æ’ä»¶åŒ–ç»“æ„å¯¹æ¯”](http://pd4brty72.bkt.clouddn.com/%E6%8F%92%E4%BB%B6%E5%8C%96%E7%BB%93%E6%9E%84%E5%AF%B9%E6%AF%94.png)

## æ’ä»¶åŒ–å’Œç»„ä»¶åŒ–çš„å¯¹æ¯”
- #### ç»„ä»¶åŒ–æ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼ˆå°è£…è®¾è®¡æ¨¡å¼ï¼‰ï¼Œè€Œæ’ä»¶åŒ–æ˜¯ä¸€ç§æŠ€æœ¯
- #### ç»„ä»¶åŒ–æ˜¯ä¸ºäº†ä»£ç çš„é«˜åº¦å¤ç”¨æ€§è€Œå‡ºç°çš„
- #### æ’ä»¶åŒ–æ˜¯ä¸ºäº†è§£å†³åº”ç”¨è¶Šæ¥è¶Šåºå¤§è€Œå‡ºç°çš„

## æ’ä»¶åŒ–ä¸åŠ¨æ€æ›´æ–°ï¼ˆçƒ­ä¿®å¤ï¼‰å¯¹æ¯”
- #### ä¸åŠ¨æ€æ›´æ–°ä¸€æ ·ï¼Œéƒ½æ˜¯åŠ¨æ€åŠ è½½æŠ€æœ¯çš„åº”ç”¨
- #### åŠ¨æ€æ›´æ–°æ˜¯ä¸ºäº†è§£å†³çº¿ä¸Šbugæˆ–å°åŠŸèƒ½çš„æ›´æ–°è€Œå‡ºç°
- #### æ’ä»¶åŒ–æ˜¯ä¸ºäº†è§£å†³åº”ç”¨è¶Šæ¥è¶Šåºå¤§è€Œå‡ºç°çš„

# æ’ä»¶åŒ–åŸç†
## ç›¸å…³çŸ¥è¯†
1. android ClassLoaderåŠ è½½classæ–‡ä»¶åŸç†
2. Java åå°„åŸç†
3. android èµ„æºåŠ è½½åŸç†
4. å››å¤§ç»„ä»¶åŠ è½½åŸç†

## Manifeastå¤„ç†
![Manifeastå¤„ç†](http://pd4brty72.bkt.clouddn.com/Manifest%E5%A4%84%E7%90%86.jpg)
1. æ„å»ºæœŸè¿›è¡Œå…¨é‡Mergeæ“ä½œ
2. Bundleçš„ä¾èµ–å•ç‹¬Merge,ç”ŸæˆBundleçš„Merge manifest
3. è§£æå„ä¸ªBundleçš„Merge Manifestï¼Œå¾—åˆ°æ•´åŒ…çš„BundleInfoListundleInfoList

## æ’ä»¶ç±»åŠ è½½
![æ’ä»¶ç±»åŠ è½½](http://pd4brty72.bkt.clouddn.com/%E6%8F%92%E4%BB%B6%E7%B1%BB%E5%8A%A0%E8%BD%BD.jpg)
1. DelegateClassLoaderä»¥PatchClassLoaderä¸ºçˆ¶classLoaderï¼Œæ‰¾ä¸åˆ°çš„æƒ…å†µä¸‹æ ¹æ®BundleListæ‰¾åˆ°å¯¹åº”çš„BundleClassLoader
2. DelegateClassLoaderçš„çˆ¶å¯¹è±¡ä¸ºBootClassLoaderï¼ŒåŒ…å«PathClassLoaderå¯¹è±¡ï¼Œå…ˆæŸ¥æ‰¾å½“å‰çš„classLoaderï¼Œå†æŸ¥æ‰¾å½“å‰PatchClassLoader


### å¦‚ä½•å®šä¹‰ClassLoaderåŠ è½½ç±»æ–‡ä»¶ï¼Ÿå¦‚ä½•è°ƒç”¨æ’ä»¶apkæ–‡ä»¶ä¸­çš„ç±»ï¼Ÿ
#### æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹ä¸€ä¸‹æ¥ç®€å•æ¨¡æ‹Ÿä¸€ä¸‹å¦‚ä½•è°ƒç”¨æ’ä»¶apkæ–‡ä»¶ä¸­çš„ç±»ã€‚
1. æ–°å»ºä¸€ä¸ªå·¥ç¨‹åç§°ä¸º*ClassLoader*,åœ¨å·¥ç¨‹é‡Œé¢æ–°å»ºä¸€ä¸ªåä¸ºBundleçš„Moduleï¼ŒModule Appï¼ˆä»£è¡¨å®¿ä¸»åº”ç”¨ï¼‰å’ŒModule Bundleï¼ˆä»£è¡¨æ’ä»¶åº”ç”¨ï¼‰ ä¸¤è€…æ²¡æœ‰ä»»ä½•ä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•é€šè¿‡å®¿ä¸»åº”ç”¨è°ƒç”¨æˆ‘ä»¬æ’ä»¶åº”ç”¨ä¸­çš„ç±»ã€‚
2. åœ¨æ’ä»¶åº”ç”¨ä¸­åˆ›å»ºä¸€ä¸ªç±»*BundleUtil*ï¼Œæ–¹ä¾¿æˆ‘ä»¬å®¿ä¸»åº”ç”¨è°ƒç”¨ã€‚
 
```
package com.lbz.bundle;

import android.util.Log;

public class BundleUtil {

    public static void printLog(){
        Log.i("bundle","I am a class in the bundle");
    }

}
```

3. å®ç°App moduleä¸­çš„ä»£ç 

```
package com.lbz.classloader;

import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;

import java.io.File;
import java.lang.reflect.Method;

import dalvik.system.DexClassLoader;

public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        //å£°æ˜ä¸€ä¸ªapk pathï¼Œä»£è¡¨æˆ‘ä»¬å½“å‰æ’ä»¶bundle.apkå­˜æ”¾çš„ä½ç½®
        String apkPath = getExternalCacheDir().getAbsolutePath() + "/bundle.apk";
        //åŠ è½½apk
        loadApk(apkPath);
    }

    private void loadApk(String apkPath) {
        File optDir = getDir("opt", MODE_PRIVATE);
        //åˆ›å»ºä¸€ä¸ªDexClassLoaderå¯¹è±¡ï¼Œé€šè¿‡å®ƒåŠ è½½æ’ä»¶apkä¸­classæ–‡ä»¶
        //1.apk pathè¦åŠ è½½apkæ–‡ä»¶è·¯å¾„
        //2.è¦å°†æˆ‘ä»¬è§£å‹å‡ºæ¥çš„æ–‡ä»¶æ”¾åœ¨å“ªé‡Œï¼Ÿapkæ˜¯ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ï¼ŒclassLoaderä¸èƒ½ç›´æ¥å¤„ç†å‹ç¼©æ–‡ä»¶ï¼Œå®ƒä¼šå°†apkæ–‡ä»¶è§£å‹åˆ°ä¸€ä¸ªè·¯å¾„ä¸­ï¼Œè€Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æŒ‡å®šæˆ‘ä»¬è§£å‹åˆ°å“ªä¸ªç›®å½•ä¸­ï¼Œå¿…é¡»æ˜¯å†…éƒ¨ç›®å½•/data
        //3.æŸ¥æ‰¾çš„å…³è”è·¯å¾„ï¼Œnullå³å¯
        //4.å½“å‰classLoaderå®ƒçš„çˆ¶classLoader,ç›´æ¥å»å½“å‰classLoaderå³å¯
        DexClassLoader classLoader = new DexClassLoader(apkPath, optDir.getAbsolutePath(), null, this.getClassLoader());
        try {
            //ä¼ å…¥æ’ä»¶apkä¸­çš„ç±»åè·å–Classå­—èŠ‚ç å¯¹è±¡
            Class cls = classLoader.loadClass("com.lbz.bundle.BundleUtil");
            if (cls != null) {
                //é€šè¿‡åå°„åˆ›å»ºå®ƒçš„å®ä¾‹å¯¹è±¡
                Object instance = cls.newInstance();
                //é€šè¿‡åå°„è·å–å®ƒçš„æ–¹æ³•
                Method method = cls.getMethod("printLog");
                //é€šè¿‡åå°„ method.invoke()è°ƒç”¨ï¼Œå¦‚æœè¯¥æ–¹æ³• æ²¡æœ‰ä»€ä¹ˆå¼‚å¸¸ï¼Œä»–å°±ä¼šæ‰“å°å‡ºBundleUtilä¸­çš„printLogæ–¹æ³•()
                method.invoke(instance);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

```
4. åœ¨module Bundle ä¸­æ‰“ä¸€ä¸ªåŒ…apkæ–‡ä»¶ï¼Œç„¶åæŠŠè¿™ä¸ªåŒ…é€šè¿‡adb pushå‘½ä»¤ä¸Šä¼ åˆ°æˆ‘ä»¬æŒ‡å®šçš„æ–‡ä»¶ç›®å½•ä¸­

```
$ adb push E:/zhiLearn/test/ClassLoader/bundle/build/outputs/apk/debug/bundle.apk \storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[  4%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[  8%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 13%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 17%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 22%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 26%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 30%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 35%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 39%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 44%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 48%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 52%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 57%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 61%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 66%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 70%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 74%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 79%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 83%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 88%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 92%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[ 97%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
[100%] storage/emulated/0/Android/data/com.lbz.classloader/cache/bundle.apk
E:/zhiLearn/test/ClassLoader/bundle/build/outputs/apk/debug/bundle.apk: 1 file pushed. 4.5 MB/s (1485932 bytes in 0.313s)

```

5. è¿è¡Œå®¿ä¸»appï¼Œå‘ç°Logæ‰“å°,æˆåŠŸè¡¨æ˜æˆ‘ä»¬çš„å®¿ä¸»è°ƒç”¨æˆ‘ä»¬çš„æ’ä»¶apkä¸­çš„ç±»ï¼Œæ˜¯åœ¨æˆ‘ä»¬æ²¡æœ‰æ·»åŠ appå’Œbundleè”ç³»çš„æƒ…å†µä¸‹é€šè¿‡*DexClassLoader*åŠ è½½æŒ‡å®šç›®å½•ä¸‹çš„apkæ–‡ä»¶ã€‚
```
08-16 14:59:11.675 21886-21886/com.lbz.classloader I/bundle: I am a class in the bundle

```
#### è‡ªå®šä¹‰ClassLoader

```
package com.lbz.bundle;

import java.io.ByteArrayOutputStream;
import java.io.FileInputStream;
import java.io.InputStream;

import dalvik.system.DexClassLoader;

public class CustomClassLoader extends DexClassLoader {

    public CustomClassLoader(String dexPath, String optimizedDirectory, String librarySearchPath, ClassLoader parent) {
        super(dexPath, optimizedDirectory, librarySearchPath, parent);
    }

    /**
     * å®šä¹‰äº†æˆ‘ä»¬è¿™ä¸ªCustomClassLoaderå®šä¹‰æˆ‘ä»¬è¦ä»¥ä½•ç§ä»€ä¹ˆç­–ç•¥åŠ è½½æˆ‘ä»¬çš„classæ–‡ä»¶ï¼Œå½“ç„¶æˆ‘ä»¬è¿™ä¸ªdemoæ²¡æœ‰ä»€ä¹ˆç­–ç•¥ï¼Œ
     * å°±æ˜¯å®ç°ä¸€ä¸ªæµç¨‹ã€‚
     */
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        byte[] classData = getClassData(name);
        if (classData != null) {
            return defineClass(name, classData, 0, classData.length);
        } else {
            throw new ClassNotFoundException();
        }
    }

    private byte[] getClassData(String name) {
        try {
            InputStream inputStream = new FileInputStream(name);
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            int bufferSize = 4096;
            byte[] buffer = new byte[bufferSize];
            int bytesNumRead = -1;
            while ((bytesNumRead = inputStream.read(buffer)) != -1) {
                baos.write(buffer, 0, bytesNumRead);
            }
            return baos.toByteArray();
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }
}

```

æˆ‘ä»¬è¿™ä¸ªç±»ä»…ä»…æ¨¡æ‹Ÿå¦‚ä½•å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„classLoaderï¼Œå¹¶æ²¡æœ‰å±äºè‡ªå·±çš„ç­–ç•¥ï¼Œåªæ˜¯ç®€å•å®Œæˆä¸€ä¸ªé€šè¿‡æŒ‡å®šè·¯å¾„å®Œæˆclasseså­—èŠ‚ç çš„åŠ è½½ã€‚ä»¥åŠé€šè¿‡è·å–çš„å­—èŠ‚ç è½¬åŒ–æˆçš„å¯¹åº”classå¯¹è±¡ã€‚

#### **æ˜¯ä¸æ˜¯è¦ä¸ºæ¯ä¸€ä¸ªæ’ä»¶apkéƒ½è¦åˆ›å»ºä¸€ä¸ªclassLoader**ï¼Ÿ
ç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚åŸå› ï¼š
1. androidç³»ç»Ÿä¼šä¸ºæ¯ä¸€ä¸ªå®‰è£…è¿‡çš„åº”ç”¨ç¨‹åºè‡³å°‘åˆ†é…ä¸€ä¸ªclassLoaderå°±æ˜¯PathClassLoaderï¼Œæ’ä»¶åŒ–æ¡†æ¶æ˜¯æ›¿ä»£androidç³»ç»Ÿçš„ï¼Œæ‰€ä»¥ä»–è¦ä¸ºæ¯ä¸€ä¸ªæ’ä»¶åˆ›å»ºä¸€ä¸ªå¯¹åº”classLoaderã€‚
2. å®¿ä¸»æˆ–è€…æ’ä»¶ç±»åå¯èƒ½åŒåï¼Œå¦‚æœä¸ä¸ºæ¯ä¸€ä¸ªæ’ä»¶å•ç‹¬åˆ›å»ºä¸€ä¸ªä»–è‡ªå·±classLoader,é‚£ä¹ˆè·¯å¾„ä¸€æ ·çš„ç±»åªè¦åœ¨åŠ è½½è¿‡ä¸€æ¬¡ï¼Œä»–å°±ä¸ä¼šè¢«åŠ è½½ï¼Œå°±ä¼šå‡ºç°æ’ä»¶ä¸­å¯¹åº”çš„ç±»æ°¸è¿œä¸ä¼šè¢«åŠ è½½

#### **å®é™…æ’ä»¶åŒ–æ¡†æ¶å¼€å‘ä¸­ï¼Œç±»åŠ è½½æ¨¡å—ä¸ä»…ä»…ç±»çš„æŸ¥æ‰¾åŠ è½½ï¼Œç»´æŠ¤æ¯ä¸€ä¸ªæ’ä»¶çš„classLoaderï¼Œä¿è¯æ¯ä¸€ä¸ªæ’ä»¶çš„ç±»éƒ½èƒ½è¢«åŠ è½½åˆ°**


## æ¨¡æ‹Ÿæ’ä»¶åŒ–æ¡†æ¶ç®¡ç†æ­¥éª¤

### èµ„æºåŠ è½½
1. æ‰€æœ‰çš„Bundle Resèµ„æºéƒ½æ˜¯åŠ å…¥åˆ°ä¸€ä¸ªDelegateResources
2. Bundle Install çš„æ—¶å€™å°†Res,so ç­‰ç›®å½•é€šè¿‡åå°„åŠ å…¥ï¼ˆAssetManager.addAssetPathï¼‰
3. é€šè¿‡ä¸åŒçš„packageIdæ¥åŒºåˆ†Bundleçš„èµ„æºID
4. è¦†ç›–getIdentifieræ–¹æ³•ï¼Œå…¼å®¹5.0ä»¥ä¸Šç³»ç»Ÿ

### æ ¸å¿ƒæŠ€æœ¯
1. å¤„ç†æ‰€æœ‰æ’ä»¶apkæ–‡ä»¶ä¸­çš„Manifestæ–‡ä»¶
2. ç®¡ç†å®¿ä¸»apkä¸­æ‰€æœ‰çš„æ’ä»¶apkä¿¡æ¯
3. ä¸ºæ¯ä¸ªæ’ä»¶apkåˆ›å»ºå¯¹åº”çš„ç±»åŠ è½½å™¨ï¼Œèµ„æºç®¡ç†å™¨

ä¸‹é¢é€šè¿‡ä¸€ä¸ªç®€å•çš„ç±»æ¥æ¨¡æ‹Ÿä¸ºæ’ä»¶apkåˆ›å»ºå¯¹åº”çš„ç±»åŠ è½½å™¨ï¼Œèµ„æºåŠ è½½å™¨ï¼Œä¸ºæœ€æ ¸å¿ƒæœ€åŸºæœ¬çš„å®ç°ã€‚

```
package com.lbz.bundle.plugin;

import android.content.Context;
import android.content.res.AssetManager;
import android.content.res.Resources;

import java.io.File;
import java.lang.reflect.Method;
import java.util.HashMap;

import dalvik.system.DexClassLoader;

public class PluginManager {

    private static PluginManager mInstance;

    private static Context mContext;

    private static File mOptFile;

    private static HashMap<String, PluginInfo> mPluginMap;

    private PluginManager(Context context) {
        mContext = context;
        mOptFile = mContext.getDir("opt", context.MODE_PRIVATE);
        mPluginMap = new HashMap<>();
    }

    //å•ä¾‹æ¨¡å¼
    public static PluginManager getInstance(Context context) {
        if (mInstance == null) {
            synchronized (PluginManager.class) {
                if (mInstance == null) {
                    mInstance = new PluginManager(context);
                }
            }
        }
        return mInstance;
    }

    private static DexClassLoader createPluginDexClassLoader(String apkPath) {
        DexClassLoader classLoader = new DexClassLoader(apkPath, mOptFile.getAbsolutePath(), null, null);
        return classLoader;
    }

    //ä¸ºå¯¹åº”çš„æ’ä»¶åˆ›å»ºAssetManager
    private static AssetManager createPluginAssetManager(String apkPath) {
        try {
            AssetManager assetManager = AssetManager.class.newInstance();
            Method addAssetPath = assetManager.getClass().getMethod("addAssetPath", String.class);
            addAssetPath.invoke(assetManager, apkPath);
            return assetManager;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    //ä¸ºå¯¹åº”çš„æ’ä»¶åˆ›å»ºResources
    private static Resources createPluginResources(String apkPath) {
        AssetManager assetManager = createPluginAssetManager(apkPath);
        Resources superResources = mContext.getResources();
        Resources pluginResources = new Resources(assetManager, superResources.getDisplayMetrics(), superResources.getConfiguration());
        return pluginResources;
    }

    public static PluginInfo loadApk(String apkPath) {
        if (mPluginMap.get(apkPath) != null) {
            return mPluginMap.get(apkPath);
        }
        PluginInfo pluginInfo = new PluginInfo();
        pluginInfo.mDexClassLoader = createPluginDexClassLoader(apkPath);
        pluginInfo.mAssetManager = createPluginAssetManager(apkPath);
        pluginInfo.mResources = createPluginResources(apkPath);
        mPluginMap.put(apkPath, pluginInfo);
        return pluginInfo;
    }

    static class PluginInfo {
        public DexClassLoader mDexClassLoader;
        public AssetManager mAssetManager;
        public Resources mResources;
        //
        //...
        //
    }

}

```

## æ’ä»¶åŒ–æ¡†æ¶

### æ¡†æ¶å¯¹æ¯”
å‚è€ƒSmallå®˜æ–¹æ¯”è¾ƒï¼š[COMPARISION.md](https://github.com/wequick/Small/blob/master/Android/COMPARISION.md)

ä¸ºæ–¹ä¾¿åˆ—è¡¨ï¼Œç®€å†™å¦‚ä¸‹ï¼š
```
  DyLA  : Dynamic-load-apk          @singwhatiwanna, ç™¾åº¦
  DiLA  : Direct-Load-apk           @FinalLody
  APF   : Android-Plugin-Framework  @limpoxe
  ACDD  : ACDD                      @bunnyblue
  DyAPK : DynamicAPK                @TediWang, æºç¨‹
  DPG   : DroidPlugin               @cmzy, 360
```

* åŠŸèƒ½


  \\                             | DyLA   | DiLA   | ACDD   | DyAPK  | DPG    | APF    | Small
  -------------------------------|--------|--------|--------|--------|--------|--------|--------
  åŠ è½½éç‹¬ç«‹æ’ä»¶<sup>[1]</sup>     | Ã—      | x      | âˆš      | âˆš      | Ã—      | âˆš      | âˆš
  åŠ è½½.soåç¼€æ’ä»¶                  | Ã—      | Ã—      | ! <sup>[2]</sup>     | Ã—      | Ã—      | Ã—      | âˆš
  Activityç”Ÿå‘½å‘¨æœŸ                | âˆš      | âˆš      | âˆš      | âˆš      | âˆš      | âˆš      | âˆš
  ServiceåŠ¨æ€æ³¨å†Œ                 | Ã—      | Ã—      | âˆš      | Ã—      | âˆš      | âˆš      | x <sup>[3]</sup>
  èµ„æºåˆ†åŒ…å…±äº«<sup>[4]</sup>      | Ã—      | Ã—      | ! <sup>[5]</sup> | ! <sup>[5]</sup> | Ã—      | ! <sup>[6]</sup>      | âˆš
  å…¬å…±æ’ä»¶æ‰“åŒ…å…±äº«<sup>[7]</sup>   | Ã—      | Ã—      | Ã—      | Ã—      | Ã—      | Ã—      | âˆš
  æ”¯æŒAppCompat<sup>[8]</sup>    | Ã—      | Ã—      | Ã—      | Ã—      | Ã—      | Ã—      | âˆš
  æ”¯æŒæœ¬åœ°ç½‘é¡µç»„ä»¶                 | Ã—      | Ã—      | Ã—      | Ã—      | Ã—      | Ã—      | âˆš
  æ”¯æŒè”è°ƒæ’ä»¶<sup>[9]</sup>      | Ã—      | x      | Ã—      | Ã—      | Ã—      | Ã—      | âˆš
  
  > [1] ç‹¬ç«‹æ’ä»¶ï¼šä¸€ä¸ªå®Œæ•´çš„apkåŒ…ï¼Œå¯ä»¥ç‹¬ç«‹è¿è¡Œã€‚æ¯”å¦‚ä»ä½ çš„ç¨‹åºè·‘èµ·æ·˜å®ã€QQï¼Œä½†è¿™åŠ è½½èµ·æ¥æ˜¯è¦é—¹å“ªæ ·ï¼Ÿ<br/>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;éç‹¬ç«‹æ’ä»¶ï¼šä¾èµ–äºå®¿ä¸»ï¼Œå®¿ä¸»æ˜¯ä¸ªå£³ï¼Œæ’ä»¶å¯ä½¿ç”¨å…¶èµ„æºä»£ç å¹¶åˆ†ç¦»ä¹‹ä»¥æœ€å°åŒ–ï¼Œè¿™æ‰æ˜¯ä¸šåŠ¡éœ€è¦å˜›ã€‚<br/>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- _â€œæ‰€æœ‰ä¸èƒ½åŠ è½½éç‹¬ç«‹æ’ä»¶çš„æ’ä»¶åŒ–æ¡†æ¶éƒ½æ˜¯è€æµæ°“â€_ã€‚
  
  > [2] ACDDåŠ è½½.soç”¨äº†Nativeæ–¹æ³•(libdexopt.so)ï¼Œä¸æ˜¯Javaå±‚ï¼Œæºç è§[dexopt.cpp](https://github.com/bunnyblue/ACDD/blob/master/ACDDCore/jni/dexopt.cpp)ã€‚
  
  > [3] Serviceæ›´æ–°é¢‘åº¦ä½ï¼Œå¯é¢„å…ˆæ³¨å†Œåœ¨å®¿ä¸»çš„manifestä¸­ï¼Œå¦‚æœæ²¡æœ‰å¾ˆå¥½çš„ç†ç”±è¯´æœæˆ‘ï¼Œç°ä¸æ”¯æŒã€‚
  
  > [4] è¦å®ç°å®¿ä¸»ã€å„ä¸ªæ’ä»¶èµ„æºå¯äº’ç›¸è®¿é—®ï¼Œéœ€è¦å¯¹ä»–ä»¬çš„èµ„æºè¿›è¡Œåˆ†æ®µå¤„ç†ä»¥é¿å…å†²çªã€‚
  
  > [5] è¿™äº›æ¡†æ¶ä¿®æ”¹aaptæºç ã€é‡ç¼–ã€è¦†ç›–SDK Managerä¸‹è½½çš„aaptï¼Œæˆ‘åªæƒ³è¯´_â€œæ€(wan)é¸¡(de)ç„‰(kai)ç”¨(xin)ç‰›(jiu)åˆ€(hao)â€_ã€‚<br/>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Smallä½¿ç”¨gradle-small-pluginï¼Œåœ¨åæœŸä¿®æ”¹äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå®ç°äº†_**PP**_æ®µåˆ†åŒºã€‚
  
  > [6] ä½¿ç”¨public-paddingå¯¹èµ„æºidçš„_**TT**_æ®µè¿›è¡Œåˆ†åŒºï¼Œåˆ†å¼€äº†å®¿ä¸»å’Œæ’ä»¶ã€‚ä½†æ˜¯æ’ä»¶ä¹‹é—´æ— æ³•åˆ†æ®µã€‚
  
  > [7] é™¤äº†å®¿ä¸»æä¾›ä¸€äº›å…¬å…±èµ„æºä¸ä»£ç å¤–ï¼Œæˆ‘ä»¬ä»éœ€å°è£…ä¸€äº›ä¸šåŠ¡å±‚é¢çš„å…¬å…±åº“ï¼Œè¿™äº›åº“è¢«å…¶ä»–æ’ä»¶æ‰€ä¾èµ–ã€‚<br/>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…¬å…±æ’ä»¶æ‰“åŒ…çš„ç›®çš„å°±æ˜¯å¯ä»¥å•ç‹¬æ›´æ–°å…¬å…±åº“æ’ä»¶ï¼Œå¹¶ä¸”ç›¸å…³æ’ä»¶ä¸éœ€è¦åŠ¨åˆ°ã€‚
  
  > [8] AppCompat: Android Studioé»˜è®¤æ·»åŠ çš„ä¸»é¢˜åŒ…ï¼ŒGoogleä¸»æ¨çš„Metrial DesignåŒ…ä¹Ÿä¾èµ–äºæ­¤ã€‚å¤§åŠ¿æ‰€è¶‹ã€‚
  
  > [9] è”è°ƒæ’ä»¶ï¼šä½¿ç”¨Android Studioè°ƒè¯•![ğŸ][as-debug]å®¿ä¸»æ—¶ï¼Œå¯ç›´æ¥åœ¨æ’ä»¶ä»£ç ä¸­æ·»åŠ æ–­ç‚¹è°ƒè¯•ã€‚
  
* é€æ˜åº¦

|  | ACDD | DyAPK |APF |Small |
| :------:| :------: | :------: |:------: |:------: |
| æ’ä»¶Activityä»£ç æ— éœ€ä¿®æ”¹	 | âˆš  | âˆš  |âˆš  |âˆš  |
| æ’ä»¶å¼•ç”¨å¤–éƒ¨èµ„æºæ— éœ€ä¿®æ”¹name     | Ã— | Ã— |Ã— |âˆš |
| æ’ä»¶æ¨¡å—æ— éœ€ä¿®æ”¹build.gradle	 | Ã— | Ã— |Ã— |âˆš |



å¦‚ä½•é€‰æ‹©ï¼Ÿ

**åªæœ‰Smallå’ŒAtlasæ›´æ–°æ¯”è¾ƒé¢‘ç¹ï¼Œå…¶ä½™çš„åŸºæœ¬è¶…è¿‡ä¸€å¹´ä¸¤å¹´æ²¡æœ‰æ›´æ–°äº†ï¼Œä¸å»ºè®®å†ä½¿ç”¨ï¼Œsmallå¯¹æ¯”äºatlasè¾ƒä¸ºç®€å•ï¼Œå®¹æ˜“é›†æˆï¼Œå»ºè®®ä½¿ç”¨[small](https://github.com/wequick/Small)**




